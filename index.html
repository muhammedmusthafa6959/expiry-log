<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Expiry Inventory Portal</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; background: #f4f7fb; margin:0; padding:20px; }
    .container { max-width: 1400px; margin:auto; background: #fff; padding:25px; border-radius:12px; box-shadow:0 4px 15px rgba(0,0,0,0.1); }
    h1, h2 { text-align:center; color:#333; margin-bottom:20px; }
    .input-row { display:flex; gap:15px; margin-bottom:20px; flex-wrap:wrap; }
    .input-row input, .input-row select { flex:1; min-width:150px; padding:10px; border:1px solid #ccc; border-radius:6px; font-size:14px; }
    button { padding:10px; background:#007bff; color:white; border:none; border-radius:6px; font-size:14px; cursor:pointer; transition:0.3s; }
    button:hover { background:#0056b3; }
    table { width:100%; border-collapse: collapse; margin-top:15px; table-layout:fixed; }
    th, td { padding:12px; border:1px solid #ddd; text-align:left; word-wrap:break-word; }
    th { background: #f1f1f1; cursor:pointer; }
    td button.delete-btn { background:#dc3545; }
    td button.delete-btn:hover { background:#b02a37; }
    td button.edit-btn { background:#28a745; margin-right:5px; }
    td button.edit-btn:hover { background:#1e7e34; }
    .footer { margin-top:15px; text-align:right; font-weight:bold; font-size:16px; color:#444; }
    .expired { color:red; font-weight:bold; }
    .near-expiry { color:orange; font-weight:bold; }
    .share-btn { background:#17a2b8;margin-top:10px; }
    .share-btn:hover { background:#117a8b; }
    .notification { padding:10px; background:#fff4e5; border:1px solid #ffc107; border-radius:5px; margin-bottom:10px; font-weight:bold; color:#856404; }
    .pagination { margin-top:10px; text-align:center; }
    .pagination button { margin:2px; background:#6c757d; color:white; border:none; padding:5px 10px; border-radius:5px; cursor:pointer; }
    .pagination button.active { background:#007bff; }
    #vendorReport table { width:100%; border-collapse: collapse; margin-top:10px; }
    #vendorReport th, #vendorReport td { padding:10px; border:1px solid #ccc; text-align:left; }
    #vendorReport th { background-color:#f8f8f8; }
    .print-btn { margin-top:10px; background:#6c757d; }
    .print-btn:hover { background:#5a6268; }
    .log { margin-top:10px; background: #eef; padding:10px; border:1px solid #99c; font-size:13px; white-space: pre-wrap; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Expiry Inventory Portal</h1>

    <div class="notification" id="expiryNotification">Loading database… please wait.</div>

    <div class="input-row">
      <input type="text" id="itemCode" placeholder="Enter Item Code or Barcode" />
      <input type="text" id="description" placeholder="Description" readonly />
      <input type="text" id="vendor" placeholder="Vendor" readonly />
      <input type="number" id="cost" placeholder="Cost" readonly />
      <input type="date" id="expiry" />
      <input type="number" id="qty" placeholder="Qty" />
      <button onclick="addItem()">Add</button>
    </div>

    <button class="share-btn" onclick="shareTable()">Share Table (View‑Only)</button>

    <table>
      <thead>
        <tr>
          <th onclick="sortTable('code')">Item Code / Barcode</th>
          <th onclick="sortTable('desc')">Description</th>
          <th onclick="sortTable('vendor')">Vendor</th>
          <th onclick="sortTable('cost')">Cost</th>
          <th onclick="sortTable('expiry')">Expiry Date</th>
          <th onclick="sortTable('days')">Days Left</th>
          <th onclick="sortTable('qty')">Qty</th>
          <th onclick="sortTable('total')">Total</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody id="inventoryTable"></tbody>
    </table>

    <div class="pagination" id="pagination"></div>
    <div class="footer" id="grandTotal">Grand Total: 0.00</div>

    <hr />
    <h2>Supplier/Vendor‑wise Report</h2>
    <div id="vendorReport"></div>
    <button class="print-btn" onclick="printVendorReport()">Print Vendor Report</button>
    <div class="log" id="debugLog"></div>
  </div>

  <script>
    let db = [], tableData = [], editRow = null;
    let currentPage = 1, itemsPerPage = 50;
    let isViewOnly = false;

    const logEl = document.getElementById("debugLog");
    function log(...args) {
      // log for debugging if needed
      // logEl.textContent += args.map(a => JSON.stringify(a)).join(" ") + "\n";
    }

    // Load saved tableData
    if (localStorage.getItem("portalData")) {
      try {
        tableData = JSON.parse(localStorage.getItem("portalData"));
      } catch(e) {
        console.warn("Error loading portalData", e);
      }
    }

    // Utility: compute days left
    function daysLeft(expiry) {
      const d = new Date(expiry);
      const now = new Date();
      const diff = d - now;
      return Math.ceil(diff / (1000 * 60 * 60 * 24));
    }

    // Fetch the Excel file from a fixed URL and parse it into `db`
    function loadDatabase() {
      const url = 'https://raw.githubusercontent.com/your-username/your-repo/main/data.xlsx'; // <– **CHANGE THIS** to actual raw link
      fetch(url)
        .then(resp => {
          if (!resp.ok) throw new Error(`HTTP error! status: ${resp.status}`);
          return resp.arrayBuffer();
        })
        .then(buffer => {
          const workbook = XLSX.read(buffer, { type: 'array' });
          const sheetName = workbook.SheetNames[0];
          const sheet = workbook.Sheets[sheetName];
          const raw = XLSX.utils.sheet_to_json(sheet, { header: 1 });
          db = [];
          raw.forEach((row, i) => {
            if (i === 0) return; // skip header
            if (!row[0] && !row[1]) return;
            const itemCode = row[0]?.toString().trim() || "";
            const barcode  = row[1]?.toString().trim() || "";
            const cost     = row[2] != null ? parseFloat(row[2]) : 0;
            const desc     = row[3]?.toString().trim() || "";
            const vendor   = row[4]?.toString().trim() || "";
            db.push({ ItemCode: itemCode, Barcode: barcode, Cost: cost, Description: desc, Vendor: vendor });
          });
          log("Database loaded:", db);
          document.getElementById("expiryNotification").textContent = "Database loaded – you may now add items.";
          setupCodeInputListener();
          updateTable();
        })
        .catch(err => {
          console.error("Failed to load database:", err);
          document.getElementById("expiryNotification").textContent = "Error loading database – please contact admin.";
        });
    }

    // Set up listener for itemCode input to auto‑fill other fields
    function setupCodeInputListener() {
      document.getElementById("itemCode").addEventListener("input", function() {
        const code = this.value.trim().toLowerCase();
        const item = db.find(x =>
          (x.ItemCode && x.ItemCode.toLowerCase() === code) ||
          (x.Barcode  && x.Barcode.toLowerCase() === code)
        );
        if (item) {
          document.getElementById("description").value = item.Description || "";
          document.getElementById("vendor").value = item.Vendor || "";
          document.getElementById("cost").value = item.Cost || "";
        }
      });
    }

    // Add item to table and update
    function addItem() {
      const itemCode = document.getElementById("itemCode").value.trim();
      const description = document.getElementById("description").value.trim();
      const vendor = document.getElementById("vendor").value.trim();
      const cost = parseFloat(document.getElementById("cost").value);
      const qty = parseInt(document.getElementById("qty").value);
      const expiry = document.getElementById("expiry").value;

      if (!itemCode || !qty || !expiry || isNaN(cost)) {
        alert("Please fill out all fields correctly!");
        return;
      }

      const days = daysLeft(expiry);
      const total = (cost * qty).toFixed(2);

      if (editRow) { // Edit mode
        const rowIndex = parseInt(editRow.getAttribute("data-index"));
        tableData[rowIndex] = { itemCode, description, vendor, cost, qty, expiry, total, days };
        editRow = null;
      } else { // New entry
        tableData.push({ itemCode, description, vendor, cost, qty, expiry, total, days });
      }
      
      localStorage.setItem("portalData", JSON.stringify(tableData));
      updateTable();
    }

    // Sort table by column
    function sortTable(column) {
      tableData.sort((a, b) => {
        if (column === 'code') {
          return a.ItemCode.localeCompare(b.ItemCode);
        }
        if (column === 'desc') {
          return a.Description.localeCompare(b.Description);
        }
        if (column === 'vendor') {
          return a.Vendor.localeCompare(b.Vendor);
        }
        if (column === 'cost') {
          return a.Cost - b.Cost;
        }
        if (column === 'expiry') {
          return new Date(a.Expiry) - new Date(b.Expiry);
        }
        if (column === 'days') {
          return a.Days - b.Days;
        }
        if (column === 'qty') {
          return a.Qty - b.Qty;
        }
        if (column === 'total') {
          return a.Total - b.Total;
        }
      });
      updateTable();
    }

    // Update table with pagination
    function updateTable() {
      const start = (currentPage - 1) * itemsPerPage;
      const end = start + itemsPerPage;
      const paginatedData = tableData.slice(start, end);
      
      const tableBody = document.getElementById("inventoryTable");
      tableBody.innerHTML = "";

      paginatedData.forEach((row, index) => {
        const tr = document.createElement("tr");
        tr.setAttribute("data-index", start + index);
        tr.innerHTML = `
          <td>${row.ItemCode || ''}</td>
          <td>${row.Description || ''}</td>
          <td>${row.Vendor || ''}</td>
          <td>${row.Cost.toFixed(2) || '0.00'}</td>
          <td>${row.Expiry || ''}</td>
          <td class="${row.Days < 0 ? 'expired' : (row.Days <= 30 ? 'near-expiry' : '')}">${row.Days}</td>
          <td>${row.Qty}</td>
          <td>${parseFloat(row.Total).toFixed(2)}</td>
          <td>
            <button class="edit-btn" onclick="editItem(${start + index})">Edit</button>
            <button class="delete-btn" onclick="deleteItem(${start + index})">Delete</button>
          </td>
        `;
        tableBody.appendChild(tr);
      });

      updatePagination();
      updateGrandTotal();
    }

    // Delete item
    function deleteItem(index) {
      tableData.splice(index, 1);
      localStorage.setItem("portalData", JSON.stringify(tableData));
      updateTable();
    }

    // Edit item
    function editItem(index) {
      const item = tableData[index];
      document.getElementById("itemCode").value = item.ItemCode;
      document.getElementById("description").value = item.Description;
      document.getElementById("vendor").value = item.Vendor;
      document.getElementById("cost").value = item.Cost;
      document.getElementById("expiry").value = item.Expiry;
      document.getElementById("qty").value = item.Qty;
      editRow = document.querySelector(`[data-index='${index}']`);
    }

    // Update pagination
    function updatePagination() {
      const totalPages = Math.ceil(tableData.length / itemsPerPage);
      const pagination = document.getElementById("pagination");
      pagination.innerHTML = "";
      for (let i = 1; i <= totalPages; i++) {
        const button = document.createElement("button");
        button.textContent = i;
        button.className = currentPage === i ? "active" : "";
        button.onclick = function () {
          currentPage = i;
          updateTable();
        };
        pagination.appendChild(button);
      }
    }

    // Update grand total
    function updateGrandTotal() {
      const total = tableData.reduce((sum, row) => sum + parseFloat(row.Total || 0), 0);
      document.getElementById("grandTotal").textContent = `Grand Total: ${total.toFixed(2)}`;
    }

    // Share the table as read-only
    function shareTable() {
      alert("Table shared as view-only!");
    }

    // Print Vendor Report
    function printVendorReport() {
      const vendorData = {};
      tableData.forEach(item => {
        if (!vendorData[item.Vendor]) vendorData[item.Vendor] = [];
        vendorData[item.Vendor].push(item);
      });
      
      let reportHtml = "<table><thead><tr><th>Vendor</th><th>Total Cost</th><th>Item List</th></tr></thead><tbody>";
      for (let vendor in vendorData) {
        const items = vendorData[vendor];
        const totalCost = items.reduce((sum, item) => sum + item.Total, 0).toFixed(2);
        const itemList = items.map(i => i.Description).join("<br>");
        reportHtml += `<tr><td>${vendor}</td><td>${totalCost}</td><td>${itemList}</td></tr>`;
      }
      reportHtml += "</tbody></table>";

      const newWin = window.open("", "_blank");
      newWin.document.write(reportHtml);
      newWin.document.close();
    }

    loadDatabase(); // Load data initially
  </script>
</body>
</html>
